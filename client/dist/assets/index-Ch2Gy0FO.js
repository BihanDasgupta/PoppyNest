(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const a of s)if(a.type==="childList")for(const i of a.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&n(i)}).observe(document,{childList:!0,subtree:!0});function t(s){const a={};return s.integrity&&(a.integrity=s.integrity),s.referrerPolicy&&(a.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?a.credentials="include":s.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function n(s){if(s.ep)return;s.ep=!0;const a=t(s);fetch(s.href,a)}})();const U={BASE_URL:"/",DEV:!1,MODE:"production",PROD:!0,SSR:!1,VITE_FIREBASE_API_KEY:"AIzaSyCWOp7bfcWoZka7FUUlQ9FoLt7n3-0pmMA",VITE_FIREBASE_APP_ID:"1:164545531240:web:d9c06f44a3239e39101add",VITE_FIREBASE_AUTH_DOMAIN:"poppynest-dfae2.firebaseapp.com",VITE_FIREBASE_MEASUREMENT_ID:"G-M2TQ8HKS36",VITE_FIREBASE_MESSAGING_SENDER_ID:"164545531240",VITE_FIREBASE_PROJECT_ID:"poppynest-dfae2",VITE_FIREBASE_STORAGE_BUCKET:"poppynest-dfae2.appspot.com",VITE_TEST_VAR:"hello"};console.log("All env:",U);console.log("Test var:","hello");const M={apiKey:"AIzaSyCWOp7bfcWoZka7FUUlQ9FoLt7n3-0pmMA",authDomain:"poppynest-dfae2.firebaseapp.com",projectId:"poppynest-dfae2",storageBucket:"poppynest-dfae2.appspot.com",messagingSenderId:"164545531240",appId:"1:164545531240:web:d9c06f44a3239e39101add",measurementId:"G-M2TQ8HKS36"};firebase.initializeApp(M);const y=firebase.auth(),d=firebase.firestore();d.enablePersistence().catch(o=>{o.code=="failed-precondition"?console.log("Persistence failed - multiple tabs open"):o.code=="unimplemented"&&console.log("Persistence not supported")});class _{constructor(){this.currentUser=null,this.currentUsername=null,this.authStateListener=null,this.initAuthStateListener()}initAuthStateListener(){this.authStateListener=y.onAuthStateChanged(async e=>{if(this.currentUser=e,e){const t=await d.collection("users").doc(e.uid).get();this.currentUsername=t.exists?t.data().username:e.email}else this.currentUsername=null;this.onAuthStateChanged(e)})}async onAuthStateChanged(e){if(e)this.showAuthenticatedUI(),await this.loadUserChatHistory();else{this.showLoginUI();const t=document.getElementById("login-form"),n=document.getElementById("register-form");t&&(t.style.display="block"),n&&(n.style.display="none")}}async register(e,t,n){try{const a=(await y.createUserWithEmailAndPassword(e,t)).user;return await d.collection("users").doc(a.uid).set({email:e,username:n,createdAt:firebase.firestore.FieldValue.serverTimestamp(),lastSeen:firebase.firestore.FieldValue.serverTimestamp()}),this.currentUsername=n,{success:!0,user:a}}catch(s){return{success:!1,error:s.message}}}async login(e,t){try{const s=(await y.signInWithEmailAndPassword(e,t)).user;await d.collection("users").doc(s.uid).update({lastSeen:firebase.firestore.FieldValue.serverTimestamp()});const a=await d.collection("users").doc(s.uid).get();return this.currentUsername=a.exists?a.data().username:s.email,{success:!0,user:s}}catch(n){return{success:!1,error:n.message}}}async logout(){try{return await y.signOut(),this.currentUsername=null,{success:!0}}catch(e){return{success:!1,error:e.message}}}getCurrentUser(){return this.currentUser}getCurrentUsername(){return this.currentUsername||(this.currentUser?this.currentUser.email:"")}isAuthenticated(){return this.currentUser!==null}async saveChatMessage(e){if(this.currentUser)try{const t=d.collection("users").doc(this.currentUser.uid).collection("meta").doc("chatHistory");await d.runTransaction(async n=>{const s=await n.get(t);let a=[];s.exists&&(a=s.data().messages||[]),a.push(e),n.set(t,{messages:a})})}catch{this.saveToLocalStorage(e)}}async loadUserChatHistory(){if(!this.currentUser)return[];try{const t=await d.collection("users").doc(this.currentUser.uid).collection("meta").doc("chatHistory").get();let n=[];return t.exists&&(n=t.data().messages||[]),localStorage.setItem("chatHistory",JSON.stringify(n)),n}catch{return this.loadFromLocalStorage()}}saveToLocalStorage(e){const t=JSON.parse(localStorage.getItem(`chatHistory_${this.currentUser?.uid}`))||[];t.push(e),localStorage.setItem(`chatHistory_${this.currentUser?.uid}`,JSON.stringify(t))}loadFromLocalStorage(){return JSON.parse(localStorage.getItem(`chatHistory_${this.currentUser?.uid}`))||[]}showAuthenticatedUI(){const e=document.getElementById("login-container"),t=document.getElementById("chat-container"),n=document.getElementById("user-info");e&&(e.style.display="none"),t&&(t.style.display="block"),n&&(n.textContent=`Welcome, ${this.getCurrentUsername()}`,n.style.display="block")}showLoginUI(){const e=document.getElementById("login-container"),t=document.getElementById("chat-container"),n=document.getElementById("user-info");e&&(e.style.display="flex"),t&&(t.style.display="none"),n&&(n.style.display="none")}}let m=!1,c=new _;const D=document.getElementById("chat-form"),S=document.getElementById("user-input"),r=document.getElementById("chat-box"),v=document.getElementById("goodnight-toggle"),g=document.getElementById("login-form"),h=document.getElementById("register-form"),H=document.getElementById("show-register"),P=document.getElementById("show-login"),b=document.getElementById("auth-error");window.appendMessage=u;function w(){v&&(v.onclick=N)}function C(){requestAnimationFrame(()=>{requestAnimationFrame(()=>{r.scrollTop=r.scrollHeight})})}async function p(){c.isAuthenticated()?(await c.loadUserChatHistory(),await f(),document.getElementById("chat-container").style.display="block",document.getElementById("login-container").style.display="none",C()):(await f(),document.getElementById("chat-container").style.display="none",document.getElementById("login-container").style.display="flex")}function x(){H.addEventListener("click",o=>{o.preventDefault(),g.style.display="none",h.style.display="block",B()}),P.addEventListener("click",o=>{o.preventDefault(),h.style.display="none",g.style.display="block",B()}),g.addEventListener("submit",async o=>{o.preventDefault();const e=document.getElementById("login-email").value,t=document.getElementById("login-password").value,n=await c.login(e,t);n.success?(w(),await p()):I(n.error)}),h.addEventListener("submit",async o=>{o.preventDefault();const e=document.getElementById("register-username").value,t=document.getElementById("register-email").value,n=document.getElementById("register-password").value,s=document.getElementById("register-confirm-password").value;if(n!==s){I("Passwords don't match");return}const a=await c.register(t,n,e);a.success?(w(),await p()):I(a.error)})}function I(o){b.textContent=o,b.style.display="block"}function B(){b.style.display="none"}window.logout=async()=>{if((await c.logout()).success){localStorage.removeItem("chatHistory"),r.innerHTML="",g&&(g.style.display="block"),h&&(h.style.display="none"),document.getElementById("login-container").style.display="flex",document.getElementById("chat-container").style.display="none",document.body.classList.add("cyber-night"),m=!0;const e=document.getElementById("goodnight-toggle");e&&(e.textContent="‚≠ê Rise and Shine"),await p()}};function T(){const o=document.getElementById("typing-bubble");o&&o.remove();const e=document.createElement("div");e.className="chat-message bot",e.id="typing-bubble";const t=document.createElement("div");t.className="typing-bubble",t.innerHTML='<span class="typing-dots"><span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span></span>',e.appendChild(t),r.appendChild(e),r.scrollTop=r.scrollHeight}function A(){const o=document.getElementById("typing-bubble");o&&o.remove()}function F(o){const e=o.split(new RegExp("(?<=[.!?])\\s+")).filter(s=>s.trim().length>0);if(e.length<=1||o.length<100)return[o];const t=[];let n="";for(let s=0;s<e.length;s++)n+=e[s]+" ",((s+1)%2===0||n.length>150||s===e.length-1)&&(t.push(n.trim()),n="");return t.filter(s=>s.length>0)}function R(o){const e=o.length,n=200*5,s=e/n*60*1e3,a=800,i=4e3,l=.7+Math.random()*.6;return Math.min(Math.max(s*l,a),i)}async function O(o){const e=await k(o),t=F(e);for(let n=0;n<t.length;n++){if(n>0){T();const s=R(t[n]);await new Promise(a=>setTimeout(a,s)),A()}u("bot",t[n]),await f(),n>0&&n<t.length-1&&await new Promise(s=>setTimeout(s,300+Math.random()*200))}}D.addEventListener("submit",async o=>{o.preventDefault();const e=S.value;u("user",e),S.value="",await f(),T(),await new Promise(n=>setTimeout(n,2e3)),A(),await O(e)});function u(o,e){const t=document.createElement("div");t.classList.add("chat-message",o);const n=document.createElement("div");n.classList.add("message-bubble"),n.textContent=e;const s=document.createElement("div");s.classList.add("timestamp");const a=new Date;s.textContent=a.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),t.appendChild(n),t.appendChild(s),r.appendChild(t),r.scrollTop=r.scrollHeight;const i={sender:o,text:e,timestamp:a.toISOString()};c.isAuthenticated()&&c.saveChatMessage(i);const l=JSON.parse(localStorage.getItem("chatHistory"))||[];l.push(i),localStorage.setItem("chatHistory",JSON.stringify(l))}async function f(){r.innerHTML="";let o=[];c.isAuthenticated()?o=await c.loadUserChatHistory():o=JSON.parse(localStorage.getItem("chatHistory"))||[];let e=null;o.forEach(t=>{const s=new Date(t.timestamp).toLocaleDateString(void 0,{year:"numeric",month:"long",day:"numeric"});if(s!==e){const E=document.createElement("div");E.className="chat-date-separator",E.innerHTML=`<span class="chat-date-pill">${s}</span>`,r.appendChild(E),e=s}const a=document.createElement("div");a.classList.add("chat-message",t.sender);const i=document.createElement("div");i.classList.add("message-bubble"),i.textContent=t.text;const l=document.createElement("div");l.classList.add("timestamp");const L=new Date(t.timestamp);l.textContent=L.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),a.appendChild(i),a.appendChild(l),r.appendChild(a)}),C()}function N(){const o=document.getElementById("goodnight-toggle"),e=document.body;m=!m,m?(e.classList.add("cyber-night"),localStorage.setItem("goodnightMode","true"),u("bot","üåô Goodnight!"),o.textContent="‚≠ê Rise and Shine",setTimeout(()=>{u("bot","Wishing you wonderful dreams ‚ò∫Ô∏è I'm here whenever you need me <3")},2e3)):(e.classList.remove("cyber-night"),localStorage.setItem("goodnightMode","false"),u("bot","‚òÄÔ∏è Good morning!"),o.textContent="üåô Goodnight Mode",setTimeout(()=>{u("bot","Welcome back to the daylight world ‚ò∫Ô∏è Wishing you a wonderful day <3")},1500))}async function k(o){try{const e=await fetch("http://localhost:5000/api/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:o})});if(!e.ok)throw new Error("Server error");return(await e.json()).reply}catch{return"Sorry, I couldn't connect to the server or received an invalid response. Please try again later."}}window.onload=async()=>{x(),w(),localStorage.getItem("goodnightMode")===null&&localStorage.setItem("goodnightMode","true");const o=localStorage.getItem("goodnightMode");if(o==="true"){m=!0,document.body.classList.add("cyber-night");const e=document.getElementById("goodnight-toggle");e&&(e.textContent="‚≠ê Rise and Shine")}else{m=!1,document.body.classList.remove("cyber-night");const e=document.getElementById("goodnight-toggle");e&&(e.textContent="üåô Goodnight Mode")}await p(),localStorage.setItem("previousMode",o)};
